#==============================================================#
# vlagent Configuration - VictoriaLogs Log Collection Agent
# Path: {{ vlagent_config_dir }}/vlagent.yml  
# Generated by Ansible - DO NOT EDIT MANUALLY
#==============================================================#

# Global settings
global:
  scrape_interval: {{ vlagent_scrape_interval }}

# VictoriaLogs remote write endpoint
remoteWrite:
  url: {{ vlagent_remote_write_url }}

# Position tracking
positions:
  filename: {{ vlagent_positions_file }}
  sync_period: 10s
  ignore_invalid_yaml: true

# Log scraping configurations
scrape_configs:

{% if vlagent_syslog_enabled %}
  # System logs (replaces promtail syslog collection)
  - job_name: syslog
    static_configs:
      - targets: ['localhost:0']
        labels:
          job: node
          src: syslog
          instance: "{{ inventory_hostname }}"
          cluster: "{{ node_cluster|default('nodes') }}"
          __path__: {{ vlagent_syslog_path }}
{% endif %}

{% if vlagent_docker_enabled %}
  # Docker container logs (NEW - solves Docker logging issue!)
  - job_name: docker
    docker_sd_configs:
      - host: {{ vlagent_docker_socket }}
        refresh_interval: 5s
        filters:
          - name: "status"
            values: ["running"]
    relabel_configs:
      # Extract container name (remove leading slash)
      - source_labels: [__meta_docker_container_name]
        regex: '/(.*)'
        target_label: container
        replacement: '${1}'
      
      # Extract compose service name
      - source_labels: [__meta_docker_container_label_com_docker_compose_service]
        target_label: service
      
      # Extract compose project name  
      - source_labels: [__meta_docker_container_label_com_docker_compose_project]
        target_label: project
        
      # Extract component label (custom FMP label)
      - source_labels: [__meta_docker_container_label_component]
        target_label: component
        
      # Set common labels
      - target_label: job
        replacement: docker
      - target_label: src
        replacement: docker
      - target_label: instance
        replacement: "{{ inventory_hostname }}"
      - target_label: cluster
        replacement: "{{ node_cluster|default('nodes') }}"
        
      # Set log file path using container ID
      - source_labels: [__meta_docker_container_id]
        target_label: __path__
        replacement: '/var/lib/docker/containers/${1}/${1}-json.log'

    # Pipeline to parse Docker JSON logs
    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
            time: time
      - timestamp:
          source: time  
          format: RFC3339Nano
      - output:
          source: output
{% endif %}

{% if vlagent_postgres_enabled and 'pg-' in group_names %}
  # PostgreSQL logs (for database nodes)
  - job_name: postgres
    static_configs:
      - targets: ['localhost:0']
        labels:
          job: postgres
          src: postgresql
          instance: "{{ inventory_hostname }}"
          cluster: "{{ node_cluster|default('nodes') }}"
          __path__: {{ vlagent_postgres_log_dir }}/postgresql-*.log

  # Patroni logs
  - job_name: patroni  
    static_configs:
      - targets: ['localhost:0']
        labels:
          job: patroni
          src: patroni
          instance: "{{ inventory_hostname }}"
          cluster: "{{ node_cluster|default('nodes') }}"
          __path__: {{ vlagent_postgres_log_dir }}/patroni.log

  # pgBackRest logs
  - job_name: pgbackrest
    static_configs:
      - targets: ['localhost:0'] 
        labels:
          job: pgbackrest
          src: pgbackrest
          instance: "{{ inventory_hostname }}"
          cluster: "{{ node_cluster|default('nodes') }}"
          __path__: {{ vlagent_postgres_log_dir }}/pgbackrest*.log

  # PgBouncer logs  
  - job_name: pgbouncer
    static_configs:
      - targets: ['localhost:0']
        labels:
          job: pgbouncer
          src: pgbouncer
          instance: "{{ inventory_hostname }}"
          cluster: "{{ node_cluster|default('nodes') }}"
          __path__: {{ vlagent_postgres_log_dir }}/pgbouncer.log
{% endif %}